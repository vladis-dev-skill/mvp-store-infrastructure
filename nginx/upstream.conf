# Upstream configuration for fault-tolerant load balancing

upstream backend_upstream {
    # Backend service instances
    server mvp-store-backend:8080 max_fails=3 fail_timeout=30s weight=1;
    # Add more backend instances for HA:
    # server mvp-store-backend-2:8080 max_fails=3 fail_timeout=30s weight=1;

    # Load balancing method
    least_conn;

    # Keep alive connections for better performance
    keepalive 32;
}

upstream payment_upstream {
    # Payment service instances
    # IMPORTANT: Payment service must be running before starting API Gateway
    # If payment service is not available, comment out the line below and restart gateway
    server mvp-store-payment:8080 max_fails=2 fail_timeout=20s weight=1;
    # Add more payment instances for HA:
    # server mvp-store-payment-2:8080 max_fails=2 fail_timeout=20s weight=1;

    # Load balancing method
    least_conn;

    # Keep alive connections
    keepalive 16;
}

upstream frontend_upstream {
    # Frontend service instances (Next.js)
    server mvp-store-frontend:3000 max_fails=3 fail_timeout=30s weight=1;
    # Add more frontend instances for HA:
    # server mvp-store-frontend-2:3000 max_fails=3 fail_timeout=30s weight=1;

    # Load balancing method
    least_conn;

    # Keep alive connections
    keepalive 32;
}